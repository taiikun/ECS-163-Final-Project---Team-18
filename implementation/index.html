<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Industry Interactive Visualizations (2020-2024)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Story Navigation Dots -->
    <div id="storyNav" class="story-nav"></div>

    <!-- NARRATIVE SECTION (Martini Glass Stem) -->

    <!-- Step 1: Title/Hook -->
    <section class="narrative-section bg-gradient-1">
        <div class="story-step active" data-step="0">
            <div class="story-content">
                <div class="story-text" style="grid-column: span 2; text-align: center;">
                    <h1>The Great Tech Shift: 2020–2024</h1>
                    <p>The tech industry underwent one of its most dramatic transformations in recent memory.</p>
                    <p>This dashboard reveals how tech careers transformed—and where they're headed next.</p>
                </div>
            </div>
            <div class="scroll-prompt">
                Scroll to uncover the trends that are shaping tech careers
            </div>
        </div>
    </section>

    <!-- Step 2: Stream Graph -->
    <section class="narrative-section bg-gradient-2">
        <div class="story-step" data-step="1">
            <div class="story-content">
                <div class="story-text">
                    <h2>The Salary Evolution</h2>
                    <p>Watch how tech salaries have evolved across different roles from 2020 to 2024.</p>
                    <p>The flowing streams show the average salaries for the top 10 tech positions, revealing which roles have seen the most growth.</p>
                </div>
                <div class="story-chart-container">
                    <div class="story-chart-title">Tech Salary Trends by Role</div>
                    <div id="story-stream-chart" style="width: 100%; height: 400px;"></div>
                    <div id="story-stream-legend" class="story-legend"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Step 3: Map Visualization -->
    <section class="narrative-section bg-gradient-3">
        <div class="story-step" data-step="2">
            <div class="story-content">
                <div class="story-text">
                    <h2>Geographic Impact</h2>
                    <p>Explore how tech layoffs and opportunities vary across different regions.</p>
                    <p>This map reveals the geographic patterns that have emerged in the tech industry, showing where the biggest impacts have been felt.</p>
                </div>
                <div class="story-chart-container">
                    <div class="story-chart-title">Tech Layoffs by Location</div>
                    <svg id="story-map-chart" width="600" height="400"></svg>
                </div>
            </div>
        </div>
    </section>

    <!-- Step 4: Bar Chart -->
    <section class="narrative-section bg-gradient-4">
        <div class="story-step" data-step="3">
            <div class="story-content">
                <div class="story-text">
                    <h2>Company Impact Analysis</h2>
                    <p>See which companies have been most affected by the industry changes over the past 4 years.</p>
                    <p>This graph shows the top companies by total layoff numbers from 2020 to 2024, helping you understand which parts of the industry have been hit the hardest.</p>
                </div>
                <div class="story-chart-container">
                    <div class="story-chart-title">Top Companies by Layoffs</div>
                    <svg id="story-bar-chart" width="600" height="400"></svg>
                </div>
            </div>
        </div>
    </section>

    <!-- Step 5: Line Chart -->
    <section class="narrative-section bg-gradient-5">
        <div class="story-step" data-step="4">
            <div class="story-content">
                <div class="story-text">
                    <h2>Recovery Trajectory</h2>
                    <p>Track the recovery of tech job openings over time.</p>
                    <p>This trend line shows how the job market has responded and recovered, providing insights into the industry's resilience.</p>
                </div>
                <div class="story-chart-container">
                    <div class="story-chart-title">Job Market Recovery</div>
                    <svg id="StoryLineChartJOLTS" width="600" height="400" data-rendered="false"></svg>
                </div>
            </div>
        </div>
    </section>

    <!-- Step 6: Donut Chart -->
    <section class="narrative-section bg-gradient-6">
        <div class="story-step" data-step="5">
            <div class="story-content">
                <div class="story-text">
                    <h2>Work Style Distribution</h2>
                    <p>Discover how remote, hybrid, and onsite work preferences have shaped the modern tech landscape.</p>
                    <p>This visualization shows the current distribution of work arrangements in tech companies, reflecting the lasting impact of the pandemic on workplace culture.</p>
                </div>
                <div class="story-chart-container">
                    <div class="story-chart-title">Remote vs Hybrid vs Onsite Work</div>
                    <div id="story-donut-chart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- INTERACTIVE SECTION -->
    <section class="interactive-section">
        <div class="interactive-header">
            <h2>Explore The Data</h2>
            <p>Now it's your turn to explore. Dive deep into salary trends, geographical patterns, and company data. Use
                these interactive visualizations to inform your career decisions.</p>
        </div>

        <!-- Main Interactive Stream Graph -->
        <div class="viz-card">
            <div class="viz-header">
                <h3>Tech Salary Evolution</h3>
                <p>Explore how salaries for different tech roles have evolved over time.</p>
            </div>
            <div class="viz-content">
                <div class="controls-container">
                    <div class="controls">
                        <div class="control-group">
                            <label for="aggregation-select">Time Period:</label>
                            <select id="aggregation-select">
                               <option value="quarterly">Quarterly</option> 
                               <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label> </label>
                            <button id="animate-btn" title="Click to animate the visualization">Animate Timeline</button>
                        </div>
                    </div>
                </div>
                <div id="chart-container">
                    <div class="loading">Loading interactive visualization...</div>
                </div>
                <div id="legend" class="legend"></div>
            </div>
        </div>

        <!-- Secondary Visualizations Grid -->
        <div class="visualization-grid">
            <div class="viz-card">
                <div class="viz-header">
                    <h3>Company Layoff Analysis</h3>
                    <p>See which companies had the most layoffs by year—essential intel for evaluating job stability.</p>
                </div>
                <div class="viz-content">
                    <div id="yearSelectLayoffsByCompany" style="display: none;">
                        <select></select>
                    </div>
                    <div id="yearButtonsLayoffsByCompany"></div>
                    <svg id="barChartLayoffsByCompany" width="800" height="400"></svg>
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-header">
                    <h3>Geographic Impact Analysis</h3>
                    <p>Discover which locations were hit hardest and which remained stable.</p>
                </div>
                <div class="viz-content">
                    <div id="yearButtonsLayoffsByLocation"></div>
                    <svg id="barChartLayoffsByLocation" width="800" height="400"></svg>
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-header">
                    <h3>Job Market Recovery Tracker</h3>
                    <p>Track the recovery of tech job openings month by month.</p>
                </div>
                <div class="viz-content">
                    <svg id="InteractiveLineChartJOLTS" width="800" height="400"></svg>
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-header">
                    <h3>Remote vs Hybrid vs Onsite (2023)</h3>
                    <p>Distribution of job types in the tech industry.</p>
                </div>
                <div class="viz-content">
                    <div id="donutChartRemote" style="width: 100%; height: 400px;"></div>
                </div>
            </div>

            <div class="viz-card map-card">
                <div class="viz-header">
                    <h3>Geographic Layoff Distribution</h3>
                    <p>Interactive map showing tech layoffs across the United States.</p>
                </div>
                <div class="viz-content">
                    <svg id="interactiveMap" width="800" height="500"></svg>
                </div>
            </div>
        </div>
    </section>

    <div class="tooltip" id="tooltip"></div>

    <!-- Scripts -->
    <script src="stream-graph.js"></script>
    <script src="bar-chart-layoffs-by-company.js"></script>
    <script src="bar-chart-layoffs-by-location.js"></script>
    <script src="line-chart-job-postings.js"></script>
    <script src="donut-chart-remote-vs-onsite.js"></script>

    <script>
        // Map data and functions
        const regionMap = {
            "Maine": "Northeast", "New Hampshire": "Northeast", "Vermont": "Northeast",
            "Massachusetts": "Northeast", "Rhode Island": "Northeast", "Connecticut": "Northeast",
            "New York": "Northeast", "New Jersey": "Northeast", "Pennsylvania": "Northeast",
            "Ohio": "Midwest", "Michigan": "Midwest", "Indiana": "Midwest", "Wisconsin": "Midwest",
            "Illinois": "Midwest", "Minnesota": "Midwest", "Iowa": "Midwest", "Missouri": "Midwest",
            "North Dakota": "Midwest", "South Dakota": "Midwest", "Nebraska": "Midwest", "Kansas": "Midwest",
            "Delaware": "South", "Maryland": "South", "Virginia": "South", "West Virginia": "South",
            "Kentucky": "South", "North Carolina": "South", "South Carolina": "South",
            "Georgia": "South", "Florida": "South", "Alabama": "South", "Tennessee": "South",
            "Mississippi": "South", "Arkansas": "South", "Louisiana": "South", "Texas": "South",
            "Oklahoma": "South",
            "Montana": "West", "Idaho": "West", "Wyoming": "West", "Colorado": "West",
            "New Mexico": "West", "Arizona": "West", "Utah": "West", "Nevada": "West",
            "California": "West", "Oregon": "West", "Washington": "West", "Alaska": "West", "Hawaii": "West"
        };

        // Function to create story visualizations
        async function loadStoryChart(stepIndex) {
            switch(stepIndex) {
                case 1:
                    await createStoryStreamGraph();
                    break;
                case 2:
                    await createStoryMap();
                    break;
                case 3:
                    await createStoryBarChart();
                    break;
                case 4:
                    if (!document.querySelector("#StoryLineChartJOLTS").dataset.rendered) {
                        init_line_chart_jolts_information('story');
                        document.querySelector("#StoryLineChartJOLTS").dataset.rendered = "true";
                    }
                    break;
                case 5:
                    if (!document.querySelector("#story-donut-chart").dataset.rendered) {
                        init_donut_chart_remote_vs_onsite("#story-donut-chart");
                        document.querySelector("#story-donut-chart").dataset.rendered = "true";
                    }
                    break;
            }
        }

        // Create map for story
        async function createStoryMap() {
            if (d3.select("#story-map-chart").selectAll("*").size() > 0) return;

            const svg = d3.select("#story-map-chart");
            const margin = {top: 20, right: 20, bottom: 20, left: 20};
            const width = +svg.attr("width") - margin.left - margin.right;
            const height = +svg.attr("height") - margin.top - margin.bottom;
            const chart = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const projection = d3.geoAlbersUsa()
                .translate([width / 2, height / 2])
                .scale(700);

            const path = d3.geoPath().projection(projection);
            const colorScale = d3.scaleSequentialLog(d3.interpolateReds).domain([1, 50000]);
            const regionColors = d3.scaleOrdinal()
                .domain(["Northeast", "Midwest", "South", "West", "Unknown"])
                .range(["#e1f5fe", "#f3e5f5", "#fff3e0", "#e8f5e8", "#fafafa"]);

            const tooltip = d3.select("#tooltip");

            try {
                // Load US map data
                const us = await d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
                const states = topojson.feature(us, us.objects.states);
                
                states.features.forEach(d => {
                    d.properties.region = regionMap[d.properties.name] || "Unknown";
                });

                // Draw states
                chart.append("g")
                    .selectAll("path")
                    .data(states.features)
                    .join("path")
                    .attr("class", "map-state")
                    .attr("fill", d => regionColors(d.properties.region))
                    .attr("stroke", "#999")
                    .attr("stroke-width", 0.5)
                    .attr("d", path);

                d3.csv("tech_layoffs_Q2_2024.csv").then(data => {
                    data.forEach(d => {
                        d.Laid_Off = +d.Laid_Off;
                        d.latitude = +d.latitude;
                        d.longitude = +d.longitude;
                    });
                    data = data.filter(d => d.Country === "USA");
                    // Don't cluster too aggressively - keep more individual points
                    const clusteredData = Array.from(
                        d3.rollup(data, 
                            v => ({
                                count: v.length,
                                totalLayoffs: d3.sum(v, d => d.Laid_Off),
                                latitude: d3.mean(v, d => d.latitude),
                                longitude: d3.mean(v, d => d.longitude),
                                location: v[0].Location_HQ,
                                companies: [...new Set(v.map(d => d.company))].slice(0, 3)
                            }), 
                            d => `${Math.round(d.latitude * 2) / 2},${Math.round(d.longitude * 2) / 2}`
                        ),
                        ([_, stats]) => stats
                    );

                    console.log(clusteredData);

                    // Draw circles for layoffs with better visibility
                    chart.append("g")
                        .selectAll("circle")
                        .data(clusteredData)
                        .join("circle")
                        .attr("class", "map-circle")
                        .attr("cx", d => projection([d.longitude, d.latitude])[0])
                        .attr("cy", d => projection([d.longitude, d.latitude])[1])
                        .attr("r", d => Math.max(3,Math.sqrt(d.count))) 
                        .attr("fill", d => colorScale(d.totalLayoffs))
                        .attr("stroke", "#fff")
                        .attr("stroke-width", 1)
                        .attr("opacity", 0.9)
                        .style("cursor", "pointer")
                        .on("mouseover", function(event, d) {
                            d3.select(this).attr("opacity", 1).attr("stroke-width", 2);
                            tooltip.html(`
                                <strong>${d.location}</strong><br>
                                Total Layoffs: ${d.totalLayoffs.toLocaleString()}<br>
                                Companies: ${d.count}
                            `)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 15) + "px")
                            .style("opacity", 1);
                        })
                        .on("mouseout", function() {
                            d3.select(this).attr("opacity", 0.8).attr("stroke-width", 1);
                            tooltip.style("opacity", 0);
                        });
                });

            } catch (error) {
                console.error('Error loading map data:', error);
                chart.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .style("fill", "white")
                    .text("Map data loading...");
            }
        }

        // Create stream graph for story
        async function createStoryStreamGraph() {
            if (d3.select("#story-stream-chart svg").size() > 0) return;

            if (typeof processSalaryData === 'function') {
                const data = await processSalaryData('quarterly');
                if (data && data.length > 0) {
                    createStreamGraphForStory(data, "#story-stream-chart", "#story-stream-legend");
                }
            }
        }

        // Improved stream graph creation for story with better spacing
        function createStreamGraphForStory(data, containerSelector, legendSelector) {
            const container = d3.select(containerSelector);
            container.html('');
            
            const margin = {top: 30, right: 40, bottom: 60, left: 40};
            const width = 650 - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;

            const svg = container
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
                
            // Add chart title
            const periods = [...new Set(data.map(d => d.period))].sort();
            const categories = [...new Set(data.map(d => d.category))].slice(0, 8);
            
            const stackData = periods.map(period => {
                const periodData = {period: period};
                categories.forEach(cat => {
                    const record = data.find(d => d.period === period && d.category === cat);
                    periodData[cat] = record ? record.value : 0;
                });
                return periodData;
            });
            
            const stack = d3.stack()
                .keys(categories)
                .offset(d3.stackOffsetWiggle);
            
            const series = stack(stackData);
            
            const xScale = d3.scalePoint()
                .domain(periods)
                .range([0, width])
                .padding(0.1);
            
            const yScale = d3.scaleLinear()
                .domain([
                    d3.min(series, layer => d3.min(layer, d => d[0])),
                    d3.max(series, layer => d3.max(layer, d => d[1]))
                ])
                .range([height, 0]);
            
            const area = d3.area()
                .x(d => xScale(d.data.period))
                .y0(d => yScale(d[0]))
                .y1(d => yScale(d[1]))
                .curve(d3.curveCardinal);
            
            const colorScale = d3.scaleOrdinal(d3.schemePaired);
            
            const tooltip = d3.select("#tooltip");
            
            g.selectAll(".stream-area")
                .data(series)
                .enter()
                .append("path")
                .attr("class", "stream-area")
                .attr("d", area)
                .attr("fill", d => colorScale(d.key))
                .attr("opacity", 0.8)
                .on("mouseover", function(event, d) {
                    g.selectAll(".stream-area").transition().duration(150).attr("opacity", 0.3);
                    d3.select(this).transition().duration(150).attr("opacity", 1);
                    tooltip.style("opacity", 1);
                })
                .on("mousemove", function(event, d) {
                    const [mouseX] = d3.pointer(event, this);
                    
                    // Find the closest period based on mouse position
                    const invertedX = periods.reduce((prev, curr) => {
                        const prevX = xScale(prev);
                        const currX = xScale(curr);
                        return Math.abs(currX - mouseX) < Math.abs(prevX - mouseX) ? curr : prev;
                    });
                    
                    const periodDataPoint = d.find(dataPoint => dataPoint.data.period === invertedX);
                    const value = periodDataPoint ? periodDataPoint.data[d.key] : 'N/A';

                    tooltip.html(`
                        <strong>${d.key}</strong><br>
                        Period: ${invertedX}<br>
                        Average Salary: $${value.toLocaleString()}
                    `)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 15) + "px");
                })
                .on("mouseout", function() {
                    g.selectAll(".stream-area").transition().duration(150).attr("opacity", 0.8);
                    tooltip.style("opacity", 0);
                });
            
            // Add x-axis with better spacing
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d => {
                    // Show only every other tick for better spacing
                    const index = periods.indexOf(d);
                    return index % 2 === 0 ? d : "";
                }))
                .selectAll("text")
                .style("fill", "white")
                .style("font-size", "12px")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");
            
            // Create legend
            const legend = d3.select(legendSelector);
            legend.html('');
            
            categories.forEach(category => {
                const item = legend.append("div")
                    .attr("class", "story-legend-item");
                
                item.append("div")
                    .attr("class", "story-legend-color")
                    .style("background-color", colorScale(category));
                
                item.append("span")
                    .text(category.length > 20 ? category.substring(0, 17) + "..." : category)
                    .style("font-size", "11px");
            });
        }

        // Create bar chart for story
        async function createStoryBarChart() {
            if (d3.select("#story-bar-chart").selectAll("*").size() > 0) return;

            try {
                const response = await fetch('tech_layoffs_combined.csv');
                const text = await response.text();
                const lines = text.split('\n').filter(line => line.trim());
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(';');
                    if (parts.length >= 2) {
                        const company = parts[0]?.trim();
                        const laidOff = parseInt(parts[1]) || 0;
                        if (company && laidOff > 0) {
                            data.push({ company, laidOff });
                        }
                    }
                }

                if (data.length > 0) {
                    createBarChartForStory(data, "#story-bar-chart");
                }
            } catch (error) {
                console.error('Error loading bar chart data');
            }
        }

        function createBarChartForStory(data, containerSelector) {
            const svg = d3.select(containerSelector);
            const margin = {top: 30, right: 20, bottom: 100, left: 60};
            const width = +svg.attr("width") - margin.left - margin.right;
            const height = +svg.attr("height") - margin.top - margin.bottom;
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // Add chart title
            g.append("text")
                .attr("class", "chart-title")
                .attr("x", width / 2)
                .attr("y", -margin.top / 2)
                .style("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "500")
                .style("fill", "white")
                .text("Top Companies by Layoffs");
            
            // Add axis labels
            g.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .style("font-size", "13px")
                .style("font-family", "sans-serif")
                .style("font-weight", "500")
                .style("fill", "white")
                .text("Company");

            g.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 15)
                .style("font-size", "13px")
                .style("font-family", "sans-serif")
                .style("font-weight", "500")
                .style("fill", "white")
                .text("Number of Layoffs");
            
            // Process data to get actual company names
            const processedData = [];
            
            data.forEach(d => {
                if (d.company && d.laidOff > 0) {
                    const companyName = d.company.trim();
                    const existingEntry = processedData.find(item => item.company === companyName);
                    
                    if (existingEntry) {
                        existingEntry.total += d.laidOff;
                    } else {
                        processedData.push({
                            company: companyName,
                            total: d.laidOff
                        });
                    }
                }
            });
            
            const topCompanies = processedData
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            const x = d3.scaleBand()
                .range([0, width])
                .domain(topCompanies.map(d => d.company))
                .padding(0.2);
            
            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(topCompanies, d => d.total)]);
            
            const tooltip = d3.select("#tooltip");
            
            // Create bars with enhanced interactivity
            g.selectAll(".bar")
                .data(topCompanies)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.company))
                .attr("width", x.bandwidth())
                .attr("y", d => y(d.total))
                .attr("height", d => height - y(d.total))
                .attr("fill", "#1f77b4")
                .style("cursor", "pointer")
                .on("mouseover", function(event, d) {
                    d3.select(this)
                        .raise()
                        .transition()
                        .duration(150)
                        .attr("width", x.bandwidth() + 4)
                        .attr("x", x(d.company) - 2)
                        .attr("y", y(d.total) - 5)
                        .attr("height", height - y(d.total) + 5)
                        .attr("fill", "#764ba2");

                    tooltip.transition().duration(150).style("opacity", 1);
                    tooltip.html(`
                        <strong>${d.company}</strong><br>
                        Total Layoffs: ${d.total.toLocaleString()}
                    `)
                    .style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 15) + "px");
                })
                .on("mousemove", function(event, d) {
                    tooltip
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 15) + "px");
                })
                .on("mouseout", function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(150)
                        .attr("width", x.bandwidth())
                        .attr("x", x(d.company))
                        .attr("y", y(d.total))
                        .attr("height", height - y(d.total))
                        .attr("fill", "#1f77b4");

                    tooltip.transition().duration(200).style("opacity", 0);
                });
            
            // Add animated entrance for bars
            g.selectAll(".bar")
                .attr("y", height)
                .attr("height", 0)
                .transition()
                .duration(800)
                .delay((d, i) => i * 50)
                .attr("y", d => y(d.total))
                .attr("height", d => height - y(d.total));
            
            // Add x-axis with better alignment
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("y", 10)
                .attr("x", -5)
                .attr("transform", "rotate(-30)")
                .style("text-anchor", "end")
                .style("fill", "white")
                .style("font-size", "12px");
            
            g.append("g")
                .call(d3.axisLeft(y))
                .selectAll("text")
                .style("fill", "white")
                .style("font-size", "12px");
        }  

        // Interactive map function
        async function initInteractiveMap() {
            const svg = d3.select("#interactiveMap");
            const margin = {top: 20, right: 20, bottom: 20, left: 20};
            const width = +svg.attr("width") - margin.left - margin.right;
            const height = +svg.attr("height") - margin.top - margin.bottom;
            const chart = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const projection = d3.geoAlbersUsa()
                .translate([width / 2, height / 2])
                .scale(900);

            const path = d3.geoPath().projection(projection);
            const colorScale = d3.scaleSequentialLog(d3.interpolateReds).domain([1, 50000]);
            const regionColors = d3.scaleOrdinal()
                .domain(["Northeast", "Midwest", "South", "West", "Unknown"])
                .range(["#e1f5fe", "#f3e5f5", "#fff3e0", "#e8f5e8", "#fafafa"]);

            const tooltip = d3.select("#tooltip");

            try {
                // Load US map data
                const us = await d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
                const states = topojson.feature(us, us.objects.states);
                
                states.features.forEach(d => {
                    d.properties.region = regionMap[d.properties.name] || "Unknown";
                });

                // Draw states
                chart.append("g")
                    .selectAll("path")
                    .data(states.features)
                    .join("path")
                    .attr("class", "map-state")
                    .attr("fill", d => regionColors(d.properties.region))
                    .attr("stroke", "#999")
                    .attr("stroke-width", 0.5)
                    .attr("d", path);

                d3.csv("tech_layoffs_Q2_2024.csv").then(data => {
                    data.forEach(d => {
                        d.Laid_Off = +d.Laid_Off;
                        d.latitude = +d.latitude;
                        d.longitude = +d.longitude;
                    });
                    data = data.filter(d => d.Country === "USA");
                    // Don't cluster too aggressively - keep more individual points
                    const clusteredData = Array.from(
                        d3.rollup(data, 
                            v => ({
                                count: v.length,
                                totalLayoffs: d3.sum(v, d => d.Laid_Off),
                                latitude: d3.mean(v, d => d.latitude),
                                longitude: d3.mean(v, d => d.longitude),
                                location: v[0].Location_HQ,
                                companies: [...new Set(v.map(d => d.company))].slice(0, 3)
                            }), 
                            d => `${Math.round(d.latitude * 2) / 2},${Math.round(d.longitude * 2) / 2}`
                        ),
                        ([_, stats]) => stats
                    );

                    console.log(clusteredData);

                    // Draw circles for layoffs with better visibility
                    chart.append("g")
                        .selectAll("circle")
                        .data(clusteredData)
                        .join("circle")
                        .attr("class", "map-circle")
                        .attr("cx", d => projection([d.longitude, d.latitude])[0])
                        .attr("cy", d => projection([d.longitude, d.latitude])[1])
                        .attr("r", d => Math.max(3,Math.sqrt(d.count))) 
                        .attr("fill", d => colorScale(d.totalLayoffs))
                        .attr("stroke", "#fff")
                        .attr("stroke-width", 1)
                        .attr("opacity", 0.9)
                        .style("cursor", "pointer")
                        .on("mouseover", function(event, d) {
                            d3.select(this).attr("opacity", 1).attr("stroke-width", 2);
                            tooltip.html(`
                                <strong>${d.location}</strong><br>
                                Total Layoffs: ${d.totalLayoffs.toLocaleString()}<br>
                                Companies: ${d.count}
                            `)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 15) + "px")
                            .style("opacity", 1);
                        })
                        .on("mouseout", function() {
                            d3.select(this).attr("opacity", 0.8).attr("stroke-width", 1);
                            tooltip.style("opacity", 0);
                        });
                });
                // Add legend
                const legendGroup = chart.append("g")
                    .attr("transform", `translate(20, 20)`);

                const legendData = [
                    {label: "1-1K", color: colorScale(500)},
                    {label: "1K-5K", color: colorScale(3000)},
                    {label: "5K-15K", color: colorScale(10000)},
                    {label: "15K+", color: colorScale(20000)}
                ];

                legendData.forEach((d, i) => {
                    const legendItem = legendGroup.append("g")
                        .attr("transform", `translate(0, ${i * 25})`);
                    
                    legendItem.append("circle")
                        .attr("r", 8)
                        .attr("fill", d.color)
                        .attr("stroke", "#fff")
                        .attr("stroke-width", 1);
                    
                    legendItem.append("text")
                        .attr("x", 15)
                        .attr("y", 5)
                        .style("font-size", "12px")
                        .style("fill", "#333")
                        .text(d.label);
                });

                legendGroup.append("text")
                    .attr("x", 0)
                    .attr("y", -10)
                    .style("font-size", "14px")
                    .style("font-weight", "bold")
                    .style("fill", "#333")
                    .text("Layoffs");

            } catch (error) {
                console.error('Error loading interactive map:', error);
                chart.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .style("fill", "#666")
                    .text("Error loading map data");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing interactive visualizations...');

            setTimeout(() => {
                if (typeof updateVisualization === 'function') updateVisualization();
                if (typeof init_bar_chart_layoffs_by_company === 'function') init_bar_chart_layoffs_by_company();
                if (typeof init_bar_chart_layoffs_by_location === 'function') init_bar_chart_layoffs_by_location();
                if (typeof init_line_chart_jolts_information === 'function') {
                    init_line_chart_jolts_information('interactive');
                    init_line_chart_jolts_information('story');
                }
                if (typeof init_donut_chart_remote_vs_onsite === 'function') init_donut_chart_remote_vs_onsite();
                initInteractiveMap();
            }, 500);

            window.addEventListener('error', (event) => {
                if (event.target.tagName === 'SCRIPT') {
                    console.error('Error loading script:', event.target.src, event);
                } else if (event.target.tagName === 'LINK') {
                    console.error('Error loading stylesheet:', event.target.href, event);
                } else {
                    console.error('Unhandled error:', event);
                }
            }, true);
        });

        let currentStep = 0;
        const totalSteps = 6; // Updated to 6 steps

        function initStoryNavigation() {
            const nav = document.getElementById('storyNav');
            for (let i = 0; i < totalSteps; i++) {
                const dot = document.createElement('div');
                dot.className = `nav-dot ${i === 0 ? 'active' : ''}`;
                dot.addEventListener('click', () => goToStep(i));
                nav.appendChild(dot);
            }
        }

        function handleScroll() {
            const sections = document.querySelectorAll('.narrative-section');
            const viewportMiddle = window.innerHeight / 2;

            sections.forEach((section, index) => {
                const rect = section.getBoundingClientRect();
                const step = section.querySelector('.story-step');
                const navDot = document.querySelectorAll('.nav-dot')[index];

                if (!step) return; // skip if step is missing

                if (rect.top < viewportMiddle && rect.bottom > viewportMiddle) {
                    if (currentStep !== index) {
                        currentStep = index;
                        updateActiveStep(index);
                        loadStoryChart(index);
                    }
                }
            });
        }

        function updateActiveStep(stepIndex) {
            document.querySelectorAll('.nav-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === stepIndex);
            });

            document.querySelectorAll('.story-step').forEach((step, i) => {
                step.classList.toggle('active', i === stepIndex);
            });
        }

        function goToStep(stepIndex) {
            const sections = document.querySelectorAll('.narrative-section');
            if (sections[stepIndex]) {
                sections[stepIndex].scrollIntoView({ behavior: 'smooth' });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initStoryNavigation();

            let scrollTimeout;
            window.addEventListener('scroll', () => {
                if (scrollTimeout) clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(handleScroll, 16);
            });

            handleScroll();
        });
    </script>
</body>

</html>
